<div class="list-header special-table-header">
  <mat-icon>filter_list</mat-icon>

  <mat-form-field appearance="outline" class="special-form-field">
    <mat-label>{{ 'caseList.caseDate' | transloco }}</mat-label>
    <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" />
    <mat-hint>DD/MM/YYYY</mat-hint>
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>

  <mat-form-field appearance="outline" class="special-form-field">
    <mat-label>{{ 'caseList.statusVal' | transloco }}</mat-label>
    <mat-select [(value)]="selectedStatus">
      <mat-option *ngFor="let s of statusList" [value]="s">
        {{ 'caseList.status.' + s | transloco }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <span *appAdmin>
    <mat-form-field appearance="outline" class="special-form-field">
      <mat-label>{{ 'caseList.colleague' | transloco }}</mat-label>
      <mat-select [(ngModel)]="selectedEmployeeFilter">
        <mat-option [value]="null">{{ 'caseList.allEmployees' | transloco }}</mat-option>
        <mat-option *ngFor="let e of employees" [value]="e.id">
          {{ e.firstName }} {{ e.lastName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </span>

  <button mat-stroked-button class="special-clear-button" (click)="clearFilters()">
    <mat-icon>clear_all</mat-icon>
    {{ 'caseList.clearFilters' | transloco }}
  </button>

  <span class="spacer"></span>

  <span *appEmployee>
    <button mat-stroked-button class="see-my-cases-btn" (click)="toggleMyCases()">
      @if (!showMyCases) {
        <mat-icon>person</mat-icon>
      }
      @if (showMyCases) {
        <mat-icon>close</mat-icon>
      }
      {{
        showMyCases ? ('caseList.showAllCases' | transloco) : ('caseList.seeMyCases' | transloco)
      }}
    </button>
  </span>

  <button mat-flat-button class="special-add-button" [routerLink]="['/form']">
    <mat-icon>add</mat-icon>
    {{ 'caseList.addCase' | transloco }}
  </button>

  <button
    mat-icon-button
    class="special-icon-button"
    [ngClass]="{ active: viewMode === 'table' }"
    (click)="viewMode = 'table'"
  >
    <mat-icon>view_list</mat-icon>
  </button>
  <button
    mat-icon-button
    class="special-icon-button"
    [ngClass]="{ active: viewMode === 'grid' }"
    (click)="viewMode = 'grid'"
  >
    <mat-icon>grid_view</mat-icon>
  </button>
</div>

@if (filteredCases().length === 0) {
  <div class="no-results-container">
    <mat-card class="no-results-card mat-elevation-z6">
      <mat-icon class="no-results-icon" color="warn">search_off</mat-icon>
      <h2>{{ 'caseList.noResultsTitle' | transloco }}</h2>
      <p>{{ 'caseList.noResultsText' | transloco }}</p>
    </mat-card>
  </div>
}

@if (viewMode === 'table' && filteredCases().length > 0) {
  <div class="scrollable-table">
    <div class="special-table">
      <table mat-table [dataSource]="filteredCases()" class="special-mat-table">
        <ng-container matColumnDef="contractId">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseDetails.title' | transloco }}</th>
          <td mat-cell *matCellDef="let c">
            <span class="contract-id-row">
              <a mat-icon-button [routerLink]="['/cases', c.caseId]">
                <mat-icon>visibility</mat-icon>
              </a>
              <span class="contract-id-text">{{ c.contractId }}</span>
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="caseDate">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseList.caseDate' | transloco }}</th>
          <td mat-cell *matCellDef="let c">{{ c.caseDate | date }}</td>
        </ng-container>
        <ng-container matColumnDef="flightNr">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseList.flightNr' | transloco }}</th>
          <td mat-cell *matCellDef="let c">{{ c.flightNr }}</td>
        </ng-container>
        <ng-container matColumnDef="flightDepartureDate">
          <th mat-header-cell *matHeaderCellDef>{{
            'caseList.flightDepartureDate' | transloco
          }}</th>
          <td mat-cell *matCellDef="let c">{{ c.flightDepartureDate | date }}</td>
        </ng-container>
        <ng-container matColumnDef="flightArrivalDate">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseList.flightArrivalDate' | transloco }}</th>
          <td mat-cell *matCellDef="let c">{{ c.flightArrivalDate | date }}</td>
        </ng-container>
        <ng-container matColumnDef="passengerName">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseList.passengerName' | transloco }}</th>
          <td mat-cell *matCellDef="let c">{{ c.passengerName }}</td>
        </ng-container>
        <ng-container matColumnDef="reservationNumber">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseList.reservationNumber' | transloco }}</th>
          <td mat-cell *matCellDef="let c">{{ c.reservationNumber }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'caseList.statusVal' | transloco }}</th>
          <td mat-cell *matCellDef="let c">
            <span *appAdmin>
              <mat-chip
                [ngClass]="'status-' + c.status"
                style="cursor: pointer"
                (click)="openStatusDialog(c)"
              >
                {{ 'caseList.status.' + c.status | transloco }}
              </mat-chip>
            </span>
            <span *appEmployee>
              <mat-chip
                [ngClass]="'status-' + c.status"
                [style.cursor]="caseAssignedToLoggedEmployee(c) ? 'pointer' : 'default'"
                (click)="caseAssignedToLoggedEmployee(c) ? openStatusDialog(c) : null"
              >
                {{ 'caseList.status.' + c.status | transloco }}
              </mat-chip>
            </span>
            @if (isPassenger) {
              <mat-chip [ngClass]="'status-' + c.status">
                {{ 'caseList.status.' + c.status | transloco }}
              </mat-chip>
            }
          </td>
        </ng-container>
        <ng-container matColumnDef="colleague">
          @if (hasAnyColleague()) {
            <th mat-header-cell *matHeaderCellDef>{{ 'caseList.colleague' | transloco }}</th>
          }
          <td mat-cell *matCellDef="let c">
            @if (!c.colleague) {
              <span *appAdmin>
                <div class="colleague-cell-row">
                  <mat-form-field appearance="fill" class="employee-dropdown">
                    <mat-select [(ngModel)]="selectedEmployee[c.caseId]">
                      <mat-option *ngFor="let e of employees" [value]="e.id">
                        {{ e.firstName }} {{ e.lastName }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <button
                    mat-button
                    color="primary"
                    class="assign-btn"
                    (click)="assignEmployee(c.caseId)"
                  >
                    {{ 'caseList.assign' | transloco }}
                  </button>
                </div>
              </span>

              <span *appEmployee>
                <div class="colleague-cell-row">
                  <mat-form-field appearance="fill" class="employee-dropdown">
                    <mat-select [(ngModel)]="selectedEmployee[c.caseId]">
                      <mat-option *ngFor="let e of employees" [value]="e.id">
                        {{ e.firstName }} {{ e.lastName }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <button
                    mat-button
                    color="primary"
                    class="assign-btn"
                    (click)="assignEmployee(c.caseId)"
                  >
                    {{ 'caseList.assign' | transloco }}
                  </button>
                </div>
              </span>
            } @else {
              <span class="employee-text">{{ c.colleague }}</span>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      <mat-paginator
        [length]="caseService.totalCasesSignal()"
        [pageSize]="caseService.getPageSize()"
        [pageIndex]="caseService.getPageIndex()"
        [pageSizeOptions]="[5, 15, 50]"
        (page)="onPageChange($event)"
      ></mat-paginator>
    </div>
  </div>
}

@if (viewMode === 'grid' && filteredCases().length > 0) {
  <div class="scrollable-list">
    <div class="list-grid">
      <mat-card *ngFor="let c of filteredCases()" class="case-card mat-elevation-z4">
        <div class="card-header">
          <div>
            <h3>{{ 'caseDetails.title' | transloco }} {{ c.contractId }}</h3>
            <p class="subtitle">
              {{ 'caseList.reservationNumber' | transloco }}: {{ c.reservationNumber }}
            </p>
          </div>
          <a mat-icon-button [routerLink]="['/cases', c.caseId]" class="contract-id-link">
            <mat-icon class="contract-id-icon">visibility</mat-icon>
          </a>
        </div>

        <div class="card-body">
          <div>{{ 'caseList.caseDate' | transloco }}: {{ c.caseDate | date }}</div>
          <div>{{ 'caseList.flightNr' | transloco }}: {{ c.flightNr }}</div>
          <div>{{ 'caseList.passengerName' | transloco }}: {{ c.passengerName }}</div>
          <div>
            <span>{{ 'caseList.colleague' | transloco }}: </span>
            @if (c.colleague) {
              <span>{{ c.colleague }}</span>
            } @else {
              <span *appAdmin>
                <mat-form-field appearance="fill" class="employee-dropdown">
                  <mat-select [(ngModel)]="selectedEmployee[c.caseId]">
                    <mat-option *ngFor="let e of employees" [value]="e.id">
                      {{ e.firstName }} {{ e.lastName }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <button
                  mat-button
                  color="primary"
                  class="assign-btn"
                  (click)="assignEmployee(c.caseId)"
                >
                  {{ 'caseList.assign' | transloco }}
                </button>
              </span>
              <span *appEmployee>
                <mat-form-field appearance="fill" class="employee-dropdown">
                  <mat-select [(ngModel)]="selectedEmployee[c.caseId]">
                    <mat-option *ngFor="let e of employees" [value]="e.id">
                      {{ e.firstName }} {{ e.lastName }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <button
                  mat-button
                  color="primary"
                  class="assign-btn"
                  (click)="assignEmployee(c.caseId)"
                >
                  {{ 'caseList.assign' | transloco }}
                </button>
              </span>
            }
          </div>
          <div>
            @if (isPassenger) {
              <mat-chip [ngClass]="'status-' + c.status">
                {{ 'caseList.status.' + c.status | transloco }}
              </mat-chip>
            }
            <span *appAdmin>
              <mat-chip
                [ngClass]="'status-' + c.status"
                style="cursor: pointer"
                (click)="openStatusDialog(c)"
              >
                {{ 'caseList.status.' + c.status | transloco }}
              </mat-chip>
            </span>
            <span *appEmployee>
              <mat-chip
                [ngClass]="'status-' + c.status"
                [style.cursor]="caseAssignedToLoggedEmployee(c) ? 'pointer' : 'default'"
                (click)="caseAssignedToLoggedEmployee(c) ? openStatusDialog(c) : null"
              >
                {{ 'caseList.status.' + c.status | transloco }}
              </mat-chip>
            </span>
          </div>
        </div>

        <div class="card-footer">
          <span class="date-chip departure">
            {{ 'caseList.flightDepartureDate' | transloco }}: {{ c.flightDepartureDate | date }}
          </span>
          <span class="date-chip arrival">
            {{ 'caseList.flightArrivalDate' | transloco }}: {{ c.flightArrivalDate | date }}
          </span>
        </div>
      </mat-card>
    </div>
    <mat-paginator
      [length]="caseService.totalCasesSignal()"
      [pageSize]="caseService.getPageSize()"
      [pageIndex]="caseService.getPageIndex()"
      [pageSizeOptions]="[5, 15, 50]"
      (page)="onPageChange($event)"
    ></mat-paginator>
  </div>
}
